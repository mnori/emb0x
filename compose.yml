services:
  webapp:
    image: webapp
    container_name: webapp
    build: 
      context: .
      dockerfile: webapp/Dockerfile
    depends_on:
      database:
        condition: service_healthy
    restart: always
    environment:
      ConnectionStrings__Emb0xDatabaseContext: "Server=database;Database=emb0x;Port=3306;User=root;Password=confidentcats4eva;allowPublicKeyRetrieval=true;SslMode=None;"
      MYSQL_HOST: database
      MYSQL_USER: root
      MYSQL_PASSWORD: confidentcats4eva
      MYSQL_DATABASE: emb0x
    ports:
      - "5000:5000"
    volumes:
      - shared-upload-data:/app/shared-upload-data # Shared volume for uploads
  
  database: 
    image: mysql
    container_name: database
    volumes:
      - db-volume:/var/lib/mysql
    restart: always
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: confidentcats4eva
      MYSQL_DATABASE: emb0x
    healthcheck: # this is used to check if the database is up and running
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 1s
      timeout: 3s
      retries: 20

  import-manager:
    build:
      context: .
      dockerfile: import-manager/Dockerfile
    container_name: import-manager
    depends_on:
      database:
        condition: service_healthy
    restart: always
    environment:
      ConnectionStrings__Emb0xDatabaseContext: "Server=database;Database=emb0x;Port=3306;User=root;Password=confidentcats4eva;allowPublicKeyRetrieval=true;SslMode=None;"
    volumes: # where will the actual daemon code go?
      - ./import-manager:/app/import-manager # Mount the actual bit where the daemon code is
      - shared-upload-data:/app/shared-upload-data # Shared volume for uploads

volumes:
  db-volume:
  shared-upload-data: # Define the shared volume

